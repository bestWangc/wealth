{extend name="base/base" /}

{block name="title"}系统公告-{$siteName}{/block}

{block name="main"}
<div id="wrapper">
    <nav class="navbar navbar-default top-navbar" role="navigation">
        {include file="base/top"}
    </nav>
    {include file="base/left"}

    <div id="page-wrapper" class="col-sm-9 col-md-10 col-xs-12" style="float:right">
        <div id="page-inner">
            <!-- /. ROW  -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3>支付宝/微信</h3>
                        </div>

                        <div class="panel-body">
                            <!--面板内容 start-->
                            <div class="row">
                                <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                                    <div class="tab-content dashboard-content" id="recharge">

                                        <div class="row">
                                            <div class="form-group col-12 col-sm-12 col-md-6">
                                                <label for="recharge_money">充值金额 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="recharge_money" placeholder="最低充值{$coinPrice}元">
                                                <input type="hidden" class="form-control" id="min_money" value="{$coinPrice}">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="form-group col-12 col-sm-12 col-md-12">
                                                <label>充值方式 <span class="text-danger">*</span></label>
                                            </div>
                                        </div>
                                        <div class="row rechargeWay">
                                            <div class="col-6 col-sm-6 col-md-6">
                                                <span data-val="1"><img src="/static/index/images/recharge/zhifubao.png" alt="">支付宝</span>
                                            </div>
                                            <div class="col-6 col-sm-6 col-md-6">
                                                <span data-val="0"><img src="/static/index/images/recharge/weixin.png" alt="">微信</span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-primary btn-lg pull-right rechargeBtn">充值</button>
                                        <div class="clearfix"> </div>

                                    </div>
                                </div>
                            </div>
                            <!--面板内容 end-->
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 col-sm-12 col-xs-12">

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            最近10笔充值记录
                        </div>
                        <a href="#" class="pull-right" style="margin-right: 1rem;">充值记录</a>
                        <div class="clearfix"></div>

                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead>
                                    <tr>
                                        <th>流水号</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>提交时间</th>
                                        <th>到账时间</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {volist name="list" id="vo"}
                                    <tr>
                                        <td>{$vo.order_no}</td>
                                        <td>{$vo.amount}</td>
                                        <td>{$vo.status == 1 ? '充值成功' : '充值中'}</td>
                                        <td>{:get_date_full($vo.created_date)}</td>
                                        <td>{:empty($vo.updated_date) ? '' : get_date_full($vo.updated_date)}</td>
                                    </tr>
                                    {/volist}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <footer>
                {include file="base/footer"}
            </footer>
        </div>
        <!-- /. PAGE INNER  -->
    </div>
    <!-- /. PAGE WRAPPER  -->
</div>

<div class="rechargeModal">
    <div id="rechargeImg" style="text-align: center;width: 100%"></div>
    <p class="text-muted">付款成功后10分钟内到账，请刷新查看余额。</p>
</div>

<script src="/static/common/js/jquery-qrcode/jquery.qrcode.min.js"></script>
{/block}

{block name="my-js"}
<script>
    $(function () {
        $('.rechargeWay div').click(function () {
            $(this).addClass('active').siblings('div').removeClass('active');
        });

        //充值
        $('.rechargeBtn').click(function () {
            let recharge_money = $('#recharge_money').val();
            let min_money = $('#min_money').val();
            if(recharge_money == ''){
                layer.msg('充值金额不能为空',{time:1000});
                return false;
            }
            let errorNum = textChecked(recharge_money);
            if(errorNum > 0){
                layer.msg('充值金额只能为数字',{time:1000});
                return false;
            }
            recharge_money = parseInt(recharge_money);
            min_money = parseInt(min_money);
            if(recharge_money < min_money){
                layer.msg('最少充值'+min_money+'元',{time:1000});
                return false;
            }

            let recharge_way = $('.rechargeWay div.active').children('span').data('val');
            if(recharge_way == undefined){
                layer.msg('请选择充值方式',{time:1000});
                return false;
            }

            layer.load(0, {
                shade: [0.1,'#fff']
            });
            $.ajax({
                url : '/index/recharge/createRecharge',
                type : "POST",
                dataType : "json",
                cache : false,
                data : {
                    recharge_money : recharge_money,
                    recharge_way : recharge_way
                },
                success : function(res){
                    layer.closeAll('loading');
                    if(res.code == 0){
                        console.log(res.data.url);
                        //判断是不是web 网站访问
                        let isWeb = checkAgents();
                        if(isWeb){
                            $('#rechargeImg').html('');
                            $('#rechargeImg').qrcode({
                                width: 190,
                                height:190,
                                text:res.data.url
                            });
                            let title = '';
                            if(res.data.way){
                                title = '打开支付宝扫一扫';
                            }else{
                                title = '打开微信扫一扫';
                            }
                            layer.open({
                                type: 1,
                                title:title,
                                area: ['40rem', '29rem'], //宽高
                                content: $('.rechargeModal')
                            });
                        }else{
                            let activeA = $('<a href="'+res.data.url+'"></a>');
                            activeA[0].click();
                        }
                    }else{
                        layer.msg(res.msg,{time: 1500});
                    }
                },
                error : function(data){
                    console.log(data);
                }
            });
        });
    });
</script>
{/block}